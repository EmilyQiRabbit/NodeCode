title: Node and BlockChain Share
speaker: Yuqi
theme: moon
date: 2018 å¹´ 4 æœˆ

[slide]

# Node & BlockChain

### ğŸŒ¸ **First, Let's Have a try!** ğŸŒ¸

-------

Just a very simple example ğŸ˜‹

[slide]

æ¨èå­¦ä¹ æ•™ç¨‹ï¼š[äº¿ä¹¦](http://bitcoin-on-nodejs.ebookchain.org)

å¯èƒ½æ˜¯è¿„ä»Šä¸ºæ­¢æœ€å¥½çš„ç½‘é¡µç‰ˆæ¼”ç¤ºåº“ï¼š[nodeppt](https://github.com/ksky521/nodeppt)

[slide]

# ç›®å½•

<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆå£¹ï¼‰åŒºå—é“¾åŸºç¡€
</div>
<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆè´°ï¼‰Node æœåŠ¡
</div>
<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆåï¼‰åŒºå—ç»“æ„
</div>
<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆè‚†ï¼‰å“ˆå¸Œç®—æ³•å’ŒåŠ å¯†
</div>
<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆä¼ï¼‰å…±è¯†æœºåˆ¶ï¼šå·¥ä½œé‡è¯æ˜ PoW
</div>
<div style='text-align: left; margin-left: 35%; line-height: 65px'>
ï¼ˆé™†ï¼‰ P2P ç½‘ç»œ
</div>

[slide]

# ï¼ˆå£¹ï¼‰åŒºå—é“¾ -- å½¢è±¡åŒ–çš„ç†è§£

> äººä»¬é€šå¸¸æŠŠå…·æœ‰å…ˆåé¡ºåºçš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨æ ˆæ¥è¡¨ç¤ºã€‚
> æˆ‘ä»¬å¯ä»¥æŠŠç¬¬ä¸€ä¸ªåŒºå—ï¼ˆåˆ›ä¸–åŒºå—ï¼‰ä½œä¸ºæ ˆåº•ï¼Œç„¶åå…¶ä»–åŒºå—æŒ‰ç…§æ—¶é—´é¡ºåºä¾æ¬¡å †å åœ¨ä¸Šé¢ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒåŒºå—ä¸é¦–åŒºå—ä¹‹é—´çš„è·ç¦»å°±è¡¨ç¤ºâ€œé«˜åº¦â€ï¼Œâ€œé¡¶ç«¯â€å°±è¡¨ç¤ºæœ€æ–°æ·»åŠ çš„åŒºå—ã€‚
> æ¯ä¸ªåŒºå—åŒ…å«å¤§é‡äº¤æ˜“ï¼Œå°±æ˜¯åŒ…å«åœ¨å¯¹åº”æ ˆé‡Œçš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™æ ·çš„ç»“æ„æƒ³è±¡æˆä¸€ä¸ªå¤§å¤§çš„æ©±æŸœï¼ŒåŒºå—å°±æ˜¯å…¶ä¸­ä¸€ä¸ªæŠ½å±‰ï¼Œæ¯ä¸ªæŠ½å±‰é‡Œéƒ½æ˜¯æ»¡æ»¡çš„äº¤æ˜“ã€‚

[slide]

# ï¼ˆå£¹ï¼‰åŒºå—é“¾çš„ç‰¹ç‚¹

* <span style='color: #e1473c'>åˆ†å¸ƒå­˜å‚¨</span>ï¼šåŒºå—é“¾å¤„äº P2P ç½‘ç»œä¹‹ä¸­ï¼Œå¿…é¡»è¦é‡‡å–åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨ä¸€ç§æœºåˆ¶ä¿è¯åŒºå—é“¾çš„åŒæ­¥å’Œç»Ÿä¸€;

-------

* <span style='color: #e1473c'>å…¬å¼€é€æ˜</span>ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªåŒºå—é“¾å‰¯æœ¬ï¼ŒåŒºå—é“¾æœ¬èº«æ²¡æœ‰åŠ å¯†ï¼Œæ•°æ®å¯ä»¥ä»»æ„æ£€ç´¢å’ŒæŸ¥è¯¢ï¼Œç”šè‡³å¯ä»¥ä¿®æ”¹ï¼ˆæ”¹äº†ä¹Ÿæ²¡ç”¨ï¼‰;

-------

* <span style='color: #e1473c'>æ— æ³•ç¯¡æ”¹</span>ï¼šè¿™æ˜¯åŠ å¯†æŠ€æœ¯çš„å·§å¦™åº”ç”¨ï¼Œ**æ¯ä¸€åŒºå—éƒ½ä¼šè®°å½•å‰ä¸€åŒºå—çš„ä¿¡æ¯ï¼Œå¹¶å®ç°éªŒè¯ï¼Œç¡®ä¿æ— æ³•ç¯¡æ”¹ã€‚è¿™é‡Œçš„æ— æ³•ç¯¡æ”¹ä¸æ˜¯ä¸èƒ½æ”¹ï¼Œè€Œæ˜¯å±€éƒ¨ä¿®æ”¹çš„æ•°æ®ï¼Œæ— æ³•é€šè¿‡éªŒè¯**ï¼Œè¦æƒ³é€šè¿‡éªŒè¯ï¼Œå¿…é¡»ä¿®æ”¹æ•´ä¸ªåŒºå—é“¾ï¼Œè¿™åœ¨ç†è®ºä¸Šå¯è¡Œï¼Œæ“ä½œä¸Šä¸å¯è¡Œ;

-------

* <span style='color: #e1473c'>æ–¹ä¾¿è¿½æº¯</span>ï¼šåŒºå—é“¾æ˜¯å…¬å¼€çš„ï¼Œä»ä»»ä¸€åŒºå—éƒ½å¯ä»¥å‘å‰è¿½æº¯ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªåŒºå—ï¼Œå¹¶é€šè¿‡åŒºå—æŸ¥åˆ°ä¸ä¹‹å…³è”çš„å…¨éƒ¨äº¤æ˜“ï¼›

-------

* <span style='color: #e1473c'>å­˜åœ¨åˆ†å‰</span>ï¼šè¿™æ˜¯ç”± P2P ç½‘ç»œç­‰ç‰©ç†ç¯å¢ƒï¼Œä»¥åŠè½¯ä»¶å¼€å‘å®è·µè¿‡ç¨‹å†³å®šçš„ï¼Œäººä»¬æ— æ³•æ ¹æœ¬æ€§æœç»ã€‚

[slide]

# ï¼ˆè´°ï¼‰Node æœåŠ¡

## npm start ğŸ‘‰ "start": "node nodeService"

**Go and Check the code in VSCode**

[slide]

# ï¼ˆåï¼‰åŒºå—ç»“æ„

```JavaScript
class Block {
  constructor(options){
    if (options){
      this.index = options.index
      this.timestamp = options.timestamp || (new Date()).getTime().toString()
      this.secrets = options.secrets
      this.hash = options.hash
      this.prevHash = options.prevHash
      this.difficulty = options.difficulty
      this.nonce = options.nonce
    }
  }
}
```

[slide]

# ï¼ˆåï¼‰ä¸€ä¸ªç®€å•çš„åˆ›ä¸–åŒºå—

```JavaScript
class Blockchain {
  constructor(){
    this.chain = []
    // åˆ›å»º åˆ›ä¸–åŒºå—
    const timestamp = (new Date()).getTime().toString()
    const genesisBlock  = new Block({
      index: 0,
      timestamp,
      secrets: 'I am the genesisBlock',
      difficulty: DIFFICULTY,
      prevHash: '',
      nonce: -1
    })
    genesisBlock.hash = calculateHash(genesisBlock);
    this.chain.push(genesisBlock)
  }

  add(block){
    this.chain.push(block)
  }
}
```

[slide]

# ï¼ˆè‚†ï¼‰å“ˆå¸Œç®—æ³•

``` JavaScript
const crypto = require('crypto');
function calculateHash(block) {
  let record = block.index + block.timestamp + block.secrets + block.prevHash + block.nonce
  return crypto.createHash('sha256').update(record).digest('hex');
}
```
[slide]

# ï¼ˆè‚†ï¼‰ç­¾åå’ŒåŠ å¯† -- ç­¾å

ç­¾åçš„ä½œç”¨æ˜¯ç¡®å®šèµ„äº§æ‰€å±ï¼Œå…¶ç‰¹å¾æ˜¯ç®€å•ã€å®‰å…¨ã€å¯éªŒè¯ã€‚

æ•°å­—è´§å¸é‡‡ç”¨æ•°å­—ç­¾åã€‚

----------

ä¸€ä¸ªæ•°å­—ç­¾åä½“ç³»åŒ…å«ä¸‹é¢çš„<span style='color: #e1473c'>ä¸‰ä¸ªç®—æ³•<span>ï¼š

**1ï¼š(sk, pk) := generateKeys( keysize )**

è¿™ä¸ªæ“ä½œç”Ÿäº§ä¸¤æŠŠé’¥åŒ™ skï¼ˆç§é’¥ï¼‰å’Œ pkï¼ˆå…¬é’¥ï¼‰ã€‚ç§é’¥ sk æ˜¯ä¸€ä¸ªç§˜å¯†ç­¾åé’¥åŒ™ï¼Œæ˜¯ä½ è¦ç­¾åä¿æŠ¤çš„ä¿¡æ¯ï¼›å…¬é’¥ pk æ˜¯å…¬å…±éªŒè¯é’¥åŒ™ï¼Œä½ å°†å…¬é’¥å…¬å¸ƒç»™æ‰€æœ‰äººï¼Œä»»ä½•äººéƒ½å¯ä»¥ç”¨å…¬é’¥æ¥éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ã€‚

**2ï¼šsig := sign( sk , message )**

ç­¾åè¿ç®—ï¼Œè¯¥è¿ç®—å°†ç§é’¥å’Œä½ æƒ³è¦ç­¾åçš„ä¿¡æ¯ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡ºçš„ sig æ˜¯ä¸€äº›å­—ä¸²ç¬¦ï¼Œè¡¨ç¤ºä½ çš„ç­¾åã€‚

**3ï¼šsValid := verify( pk , message , sig )**

éªŒè¯è®¡ç®—ï¼Œè¯¥è®¡ç®—å°†ç­¾åè€…çš„å…¬é’¥ã€è¢«ç­¾åçš„ä¿¡æ¯å’Œç­¾åæ¶ˆæ¯sigä½œä¸ºè¾“å…¥ï¼Œå¯¹è¯¥ç­¾åæ˜¯å¦æœ‰æ•ˆï¼Œä»…è¿”å›æ˜¯æˆ–å¦ã€‚

[slide]

# ï¼ˆè‚†ï¼‰ä»£ç å®ç°ï¼ˆ**From Ebooker**ï¼‰

```JavaScript
// ed25519ï¼šæ¤­åœ†æ›²çº¿åŠ å¯†/ç­¾å/å¯†é’¥äº¤æ¢ç®—æ³•
ed = require('ed25519')
// Block.prototype.create
block.blockSignature = this.sign(block, data.keypair);

...

Block.prototype.sign = function (block, keypair) {
	var hash = this.getHash(block);
	return ed.Sign(hash, keypair).toString('hex');
}

...

Block.prototype.getHash = function (block) {
	return crypto.createHash('sha256').update(this.getBytes(block)).digest();
}

```

[slide]

# ï¼ˆè‚†ï¼‰ç­¾åçš„ä»£ç å®ç°

```JavaScript
ed = require('ed25519'),
Block.prototype.getBytes = function (block) {
	var size = 4 + 4 + 8 + 4 + 4 + 8 + 8 + 4 + 4 + 4 + 32 + 32 + 64;

	try {
		var bb = new ByteBuffer(size, true);
		bb.writeInt(block.version);
		bb.writeInt(block.timestamp);

		if (block.previousBlock) {
			var pb = bignum(block.previousBlock).toBuffer({size: '8'});

			for (var i = 0; i < 8; i++) {
				bb.writeByte(pb[i]);
			}
		} else {
			for (var i = 0; i < 8; i++) {
				bb.writeByte(0);
			}
		}

		bb.writeInt(block.numberOfTransactions);
		bb.writeLong(block.totalAmount);
		bb.writeLong(block.totalFee);
		bb.writeLong(block.reward);

		bb.writeInt(block.payloadLength);

		var payloadHashBuffer = new Buffer(block.payloadHash, 'hex');
		for (var i = 0; i < payloadHashBuffer.length; i++) {
			bb.writeByte(payloadHashBuffer[i]);
		}

		var generatorPublicKeyBuffer = new Buffer(block.generatorPublicKey, 'hex');
		for (var i = 0; i < generatorPublicKeyBuffer.length; i++) {
			bb.writeByte(generatorPublicKeyBuffer[i]);
		}

		if (block.blockSignature) {
			var blockSignatureBuffer = new Buffer(block.blockSignature, 'hex');
			for (var i = 0; i < blockSignatureBuffer.length; i++) {
				bb.writeByte(blockSignatureBuffer[i]);
			}
		}

		bb.flip();
		var b = bb.toBuffer();
	} catch (e) {
		throw Error(e.toString());
	}

	return b;
}
```

[slide]

# ï¼ˆè‚†ï¼‰ç­¾åçš„éªŒè¯

```JavaScript
ed = require('ed25519'),
Block.prototype.verifySignature = function (block) {
	var remove = 64;

	try {
		var data = this.getBytes(block);
		var data2 = new Buffer(data.length - remove);

		for (var i = 0; i < data2.length; i++) {
			data2[i] = data[i];
		}
		var hash = crypto.createHash('sha256').update(data2).digest();
		var blockSignatureBuffer = new Buffer(block.blockSignature, 'hex');
		var generatorPublicKeyBuffer = new Buffer(block.generatorPublicKey, 'hex');
		var res = ed.Verify(hash, blockSignatureBuffer || ' ', generatorPublicKeyBuffer || ' ');
	} catch (e) {
		throw Error(e.toString());
	}

	return res;
}
```
[slide]

# ï¼ˆä¼ï¼‰å…±è¯†æœºåˆ¶

## **å…±è¯†**

> è´§å¸çš„æœ¬è´¨ä¸æ˜¯ä¿¡ç”¨ï¼Œè€Œæ˜¯å…±è¯†ã€‚è´§å¸æœ¬èº«ç”šè‡³å¯ä»¥æ²¡æœ‰å®ä½“çš„å­˜åœ¨ï¼Œå¦‚é›…æµ¦å²›çŸ³å¸ï¼Œåªè¦è¾¾æˆå…±è¯†ï¼Œå°±ç®—æ‘¸ä¸ç€æ²‰åœ¨æ·±æµ·ï¼Œå› ä¸ºå…±è¯†ï¼Œä¹Ÿå°†è¢«è®¤å¯ã€ç»§ç»­æµé€šã€‚

[slide]

# ï¼ˆä¼ï¼‰å…±è¯†æœºåˆ¶ï¼šå·¥ä½œé‡è¯æ˜ PoW

### ä»€ä¹ˆæ˜¯å…±è¯†æœºåˆ¶ï¼Ÿ

-------

> å…±è¯†æœºåˆ¶å¯ä»¥è¢«è§£é‡Šä¸ºï¼š**å¯ç¼–ç¨‹çš„åˆ©ç›Šè½¬ç§»è§„åˆ™**ã€‚å€ŸåŠ©å…±è¯†æœºåˆ¶ï¼ˆä¹Ÿå°±æ˜¯æŸä¸€å¥—è§„åˆ™ï¼‰ï¼ŒåŠ å¯†è´§å¸æœ‰å¯èƒ½å»ºç«‹èµ·ä¸€ä¸ªâ€œ**æ— éœ€ç›‘ç®¡**çš„è‡ªé€‚åº”ç»æµç³»ç»Ÿâ€ã€‚

-------

### ï¼ˆä¼ï¼‰ä»€ä¹ˆæ˜¯ PoW ï¼Ÿ

-------

> PoWï¼ˆProof of Workï¼‰çš„åŸç†éå¸¸ç®€å•ï¼Œå°±æ˜¯å¤šåŠ³å¤šå¾—ï¼šä½ ä»˜å‡ºå¤šå°‘åŠ³åŠ¨ï¼ˆåŠ³åŠ¨ = è®¡ç®—æœåŠ¡ = ç®—åŠ›xæ—¶é•¿ï¼‰ï¼Œå°±ä¼šè·å¾—å¤šå°‘æŠ¥é…¬ï¼ˆåŠ å¯†è´§å¸ï¼‰ã€‚æ¯”ç‰¹å¸çš„å…±è¯†æœºåˆ¶å°±æ˜¯ PoWã€‚

[slide]

# ï¼ˆä¼ï¼‰å·¥ä½œé‡è¯æ˜ PoW ä»£ç å®ç°

```JavaScript

function isHashValid(hash, difficulty) { // åˆ¤æ–­å“ˆå¸Œå€¼æ˜¯å¦æœ‰æ•ˆ
  let prefix = '0'.repeat(difficulty)
  return hash.toString().startsWith(prefix)
}

function generateBlock(oldBlock, secrets) { // ç”ŸæˆåŒºå—
  let newBlock = new Block()

  newBlock.index = oldBlock.index + 1
  newBlock.timestamp = (new Date()).getTime().toString()
  newBlock.secrets = secrets
  newBlock.prevHash = oldBlock.hash
  newBlock.difficulty = DIFFICULTY

  let hex = 0;
  while(true){
    newBlock.nonce = hex
    hex++
    const newCalculatedHash = calculateHash(newBlock);
    if (isHashValid(newCalculatedHash, newBlock.difficulty)) {
      console.log('Current hash: ', newCalculatedHash, ', work done!')
      newBlock.hash = newCalculatedHash
      break
    } else {
      console.log('Current hash: ', newCalculatedHash, ', more work!')
    }
  }
  return newBlock
}
```

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œ

### åŠ å¯†è´§å¸éƒ½æ˜¯**å»ä¸­å¿ƒåŒ–**çš„åº”ç”¨ï¼Œ
### å»ä¸­å¿ƒåŒ–çš„åŸºç¡€å°±æ˜¯ **P2Pï¼ˆpeer-to-peerï¼Œå¯¹ç­‰ç½‘ç»œï¼‰**ç½‘ç»œï¼Œå…¶ä½œç”¨å’Œåœ°ä½ä¸è¨€è€Œå–»ï¼Œæ— å¯æ›¿ä»£ã€‚

--------

#### ğŸŒ¸ <span style='color: #e1473c'>æœ¬èŠ‚åˆ†æéƒ¨åˆ†äº¿ä¹¦å¯¹äº P2P ç½‘ç»œçš„å®ç°ä»£ç <span> ğŸŒ¸

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œä¹‹è·¯ç”±æ‰©å±•ï¼ˆäº¿ä¹¦ï¼‰

### åŸºäº http çš„ web åº”ç”¨ï¼ŒæŠ“ä½**è·¯ç”±çš„å®šä¹‰ã€è®¾è®¡ä¸å®ç°**ï¼Œæ˜¯å¿«é€Ÿå¼„æ¸…ä¸šåŠ¡é€»è¾‘çš„ç®€å•æ–¹æ³•ã€‚

--------

### è¿™éƒ¨åˆ†ä»£ç åŸºäºå¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ express

--------

```JavaScript
router.map = map;
...
function map(root, config) {
    var router = this;
    Object.keys(config).forEach(function (params) { // params: "get /" ğŸ‘‰ route
        var route = params.split(" ");
        if (route.length != 2 || ["post", "get", "put"].indexOf(route[0]) == -1) {
            throw Error("wrong map config");
        }
        router[route[0]](route[1], function (req, res, next) { // ç›¸å½“äºï¼šrouter.get('path', (req, res, next) => {...})
            root[config[params]]({"body": route[0] == "get" ? req.query : req.body}, function (err, response) { 
								// ç›¸å½“äºï¼šshared.getPeers({body: req.query}, (err, response) => {...}) è¿™æ˜¯å¯¹æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ peer.js æ–‡ä»¶ä¸­å®šä¹‰äº†
                if (err) {
                    res.json({"success": false, "error": err});
                } else {
                    return res.json(extend({}, {"success": true}, response));
                }
            });
        });
    });
}
...
// peer.js
router.map(shared, { 
		"get /": "getPeers", // è¿™ä¸ªçš„å«ä¹‰æ˜¯ï¼šè·¯ç”± + æ–¹æ³•
		"get /version": "version",
		"get /get": "getPeer"
});
```

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œä¹‹è·¯ç”±æ‰©å±•ï¼ˆäº¿ä¹¦ï¼‰

### ä¸Šä¸€é¡µä»£ç è¿è¡Œçš„ç»“æœï¼Œå°±ç›¸å½“äº ğŸ‘‡

-------

```JavaScript
router.get('/peers', function(req, res, next){
    root.getPeers(...);
})
```

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œä¹‹è·¯ç”±æ‰©å±•ï¼ˆäº¿ä¹¦ï¼‰

### æˆ‘ä»¬æ¥çœ‹çœ‹ getPeers çš„ä»£ç  ğŸ‘‡

-------


```JavaScript
shared.getPeer = function (req, cb) {
	var query = req.body;
	library.scheme.validate(query, { // æ ¡éªŒè§„åˆ™
		//è¿™å°±è¯´æ˜ï¼Œæˆ‘ä»¬åº”è¯¥è¿™æ ·è¯·æ±‚ï¼šhttp://ip:port/api/peers/get?ip_str=0.0.0.0&port=1234ï¼Œä¸ç„¶ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ã€‚
		type: "object",
		properties: {
			ip_str: {
				type: "string",
				minLength: 1
			},
			port: {
				type: "integer",
				minimum: 0,
				maximum: 65535
			}
		},
		required: ['ip_str', 'port']
	}, function (err) {
		... // (next page)
	});
};
```

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œä¹‹è·¯ç”±æ‰©å±•ï¼ˆäº¿ä¹¦ï¼‰

### å›è°ƒå‡½æ•° ğŸ‘‡

-------

```JavaScript
if (err) {
	return cb(err[0].message);
}

try {
	var ip_str = ip.toLong(query.ip_str);
} catch (e) {
	return cb("Invalid peer");
}

privated.getByFilter({ // æ¶‰åŠåˆ° dblite ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œdblite å®Œæˆäº†å¯¹ sqlite æ•°æ®åº“çš„ç®€å•å°è£…

	// ğŸ™‹ï¼ˆçœ‹è¿™é‡Œï¼‰sqlite æ˜¯ä¸€æ¬¾è½»é‡çº§çš„æ•°æ®åº“ï¼Œ
	// åœ¨ node ä¸­ä½¿ç”¨å®ƒå¯ä»¥ç”¨ sqlite3ï¼šnpm install sqlite3 å°±å¥½ ğŸ‰

	ip: ip_str,
	port: port
}, function (err, peers) {
	if (err) {
		return cb("Peer not found");
	}

	var peer = peers.length ? peers[0] : null;

	if (peer) {
		peer.ip = ip.fromLong(peer.ip);
	}

	cb(null, {peer: peer || {}});
});
```

[slide]

# ï¼ˆé™†ï¼‰ P2P ç½‘ç»œä¹‹è·¯ç”±æ‰©å±•ï¼ˆäº¿ä¹¦ï¼‰

### å†çœ‹ä¸€ä¸ªå†™å…¥èŠ‚ç‚¹çš„æ —å­ ğŸ‘‡

-----

å†™å…¥èŠ‚ç‚¹ï¼Œå°±æ˜¯æŒä¹…åŒ–ï¼Œæˆ–è€…ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæˆ–è€…ä¿å­˜åˆ°æŸä¸ªæ–‡ä»¶ã€‚è¿™é‡Œä¿å­˜åˆ° sqlite3 æ•°æ®åº“é‡Œçš„ peers è¡¨äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š

-----

```JavaScript
// peer.js 347è¡Œ
Peer.prototype.onBlockchainReady = function () {
    async.eachSeries(library.config.peers.list, function (peer, cb) {
        library.dbLite.query("INSERT OR IGNORE INTO peers(ip, port, state, sharePort) VALUES($ip, $port, $state, $sharePort)", {
            ip: ip.toLong(peer.ip),
            port: peer.port,
            state: 2, //åˆå§‹çŠ¶æ€ä¸º2ï¼Œéƒ½æ˜¯å¥åº·çš„èŠ‚ç‚¹
            sharePort: Number(true)
        }, cb);
    }, function (err) {
        if (err) {
            library.logger.error('onBlockchainReady', err);
        }

        privated.count(function (err, count) {
            if (count) {
                privated.updatePeerList(function (err) {
                    err && library.logger.error('updatePeerList', err);
                    // 364è¡Œ
                    library.bus.message('peerReady');
                })
                library.logger.info('Peers ready, stored ' + count);
            } else {
                library.logger.warn('Peers list is empty');
            }
        });
    });
}
```